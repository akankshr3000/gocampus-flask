<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - GoCampus</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    body { font-family: "Inter", "Poppins", sans-serif; background:#0f172a; color:#fff; min-height:100vh }
    .header { background: rgba(15,23,42,0.8); padding:1.25rem 1.5rem; position:sticky; top:0; z-index:50; border-bottom:1px solid rgba(255,255,255,0.04) }
    .header-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .container{max-width:1200px;margin:1.5rem auto;padding:0 1rem}
    .card{background:rgba(15,23,42,0.6);padding:1.25rem;border-radius:12px;border:1px solid rgba(255,255,255,0.03);margin-bottom:1rem}
    .card-title{font-size:1.25rem;font-weight:600;margin-bottom:0.75rem}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:0.75rem}
    label{display:block;margin-bottom:0.35rem;color:#cbd5e1;font-weight:500}
    input,select{width:100%;padding:0.6rem 0.75rem;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(30,41,59,0.6);color:#fff}
    .actions-bar{display:flex;gap:0.75rem;align-items:center;margin:0.75rem 0}
    .btn { padding:0.6rem 1rem;border-radius:8px;text-decoration:none;display:inline-flex;align-items:center;gap:0.5rem }
    .btn-success{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}
    .btn-outline{background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.12);color:#86efac;padding:0.6rem 0.9rem;border-radius:8px}
    .table-container{overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:rgba(15,23,42,0.6)}
    table{width:100%;border-collapse:collapse}
    thead{background:rgba(30,41,59,0.8)}
    th,td{padding:0.75rem 0.85rem;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);vertical-align:middle}
    .badge{display:inline-block;padding:0.25rem 0.6rem;border-radius:999px;font-weight:600}
    .badge-success{background:rgba(34,197,94,0.12);color:#86efac;border:1px solid rgba(34,197,94,0.14)}
    .badge-danger{background:rgba(239,68,68,0.08);color:#fca5a5;border:1px solid rgba(239,68,68,0.12)}
    .photo-thumb{width:44px;height:44px;border-radius:6px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
    .muted{color:#94a3b8;font-size:0.92rem}
    @media(max-width:720px){.form-grid{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <div class="header">
    <div class="header-content">
      <div style="display:flex;align-items:center;gap:1rem">
        <h1 style="font-size:1.1rem; font-weight:700;">ðŸ“‹ GoCampus â€” Admin Dashboard</h1>
      </div>
      <div style="display:flex;gap:0.5rem;align-items:center">
        <a href="/help_tickets" class="btn btn-outline">ðŸ›  Help Tickets</a>
        <a href="/logout" class="btn" style="background:rgba(255,255,255,0.04);color:#ffdcdc;border-radius:8px;padding:0.5rem 0.9rem">Logout</a>
      </div>
    </div>
  </div>

  <div class="container">
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="card" style="border-left:4px solid #22c55e;">
      {% for msg in messages %}
      <div style="color:#c7f0d3">{{ msg }}</div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Add Student -->
    <div class="card">
      <div class="card-title">âž• Add New Student</div>
      <form action="/add_student" method="post" id="add-student-form" enctype="multipart/form-data">
        <div class="form-grid">
          <div>
            <label for="name">Student Name *</label>
            <input type="text" id="name" name="name" required />
          </div>
          <div>
            <label for="bus_id">Bus No * (digits only)</label>
            <input type="text" id="bus_id" name="bus_id" pattern="\d+" required />
          </div>
          <div>
            <label for="semester">Semester (1-8)</label>
            <input type="text" id="semester" name="semester" pattern="[1-8]" maxlength="1" />
          </div>
          <div>
            <label for="email">Email</label>
            <input type="email" id="email" name="email" />
          </div>
          <div>
            <label for="branch">Branch</label>
            <input type="text" id="branch" name="branch" />
          </div>
          <div>
            <label for="fee_paid">Fee Status</label>
            <select id="fee_paid" name="fee_paid">
              <option value="0" selected>Unpaid</option>
              <option value="1">Paid</option>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label for="parent_contact">Parent Contact (10 digits)</label>
            <div style="display:flex;gap:0.5rem;align-items:center">
              <div style="padding:0.5rem 0.7rem;background:rgba(255,255,255,0.03);border-radius:8px;color:#94a3b8">ðŸ‡®ðŸ‡³ +91</div>
              <input type="text" id="parent_contact" name="parent_contact" pattern="^(?!([0-9])\1{9})[0-9]{10}$" maxlength="10" placeholder="Enter 10-digit number" style="flex:1" />
            </div>
          </div>
          <div style="grid-column:1/-1">
            <label for="photo">Student Photo (JPG/PNG, max 3MB) *</label>
            <input type="file" id="photo" name="photo" accept="image/jpeg,image/png" required />
          </div>
        </div>
        <div style="text-align:right;margin-top:0.8rem">
          <button type="submit" class="btn btn-success">Add Student</button>
        </div>
      </form>
    </div>

    <div class="actions-bar">
      <a href="/export_excel" class="btn btn-outline">ðŸ“Š Export Report (Excel)</a>
    </div>

    <!-- Chart -->
    <div class="card">
      <div class="card-title">ðŸ“Š Fee Records Overview</div>
      <div style="max-width:600px;margin:0 auto"><canvas id="feeChart"></canvas></div>
    </div>

    <!-- Students table -->
    <div class="table-container card" style="padding:0;">
      <table>
        <thead>
          <tr>
            <th>Student ID</th>
            <th>Photo</th>
            <th>Name / Email</th>
            <th>Bus No</th>
            <th>Branch</th>
            <th>Semester</th>
            <th>Fee Status</th>
            <th>Payment Details</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr>
            <td style="font-weight:700">{{ s.student_id }}</td>

            <td>
              {% if s.photo_filename %}
              <img class="photo-thumb" src="{{ url_for('static', filename=('student_photos/' ~ s.photo_filename)) }}" alt="photo" />
              {% else %}
              <div class="muted">No</div>
              {% endif %}
            </td>

            <td>
              <div style="font-weight:600">{{ s.name or 'N/A' }}</div>
              <div class="muted">{{ s.email or '' }}</div>
            </td>

            <td>{{ s.bus_id or 'N/A' }}</td>
            <td>{{ s.branch or 'N/A' }}</td>
            <td>{{ s.semester or 'N/A' }}</td>

            <td>
              {% if s.fee_paid == 1 or s.fee_paid == '1' %}
                <span class="badge badge-success">Paid</span>
              {% else %}
                <span class="badge badge-danger">Unpaid</span>
              {% endif %}
            </td>

            <td>
              {% if (s.fee_paid == 1 or s.fee_paid == '1') %}
                {% if s.amount_paid %}
                  <div style="color:#86efac">â‚¹{{ "{:,}".format(s.amount_paid) }}</div>
                {% endif %}
                {% if s.transaction_date %}
                  <div class="muted">{{ s.transaction_date }}</div>
                {% endif %}
                {% if not s.amount_paid and not s.transaction_date %}
                  <div class="muted">-</div>
                {% endif %}
              {% else %}
                <div class="muted">-</div>
              {% endif %}
            </td>

            <td>
              <div style="display:flex;gap:0.5rem;align-items:center">
                {% if not (s.fee_paid == 1 or s.fee_paid == '1') %}
                <button class="btn" style="background:#f59e0b;color:#111;padding:0.4rem 0.6rem;border-radius:6px" onclick="showMarkPaidModal('{{ s.student_id }}')">Mark Paid</button>
                {% endif %}

                <form action="/delete_student" method="post" style="display:inline">
                  <input type="hidden" name="student_id" value="{{ s.student_id }}">
                  <button type="submit" class="btn" style="background:rgba(239,68,68,0.08);color:#fca5a5;padding:0.4rem 0.6rem;border-radius:6px">Delete</button>
                </form>

              </div>
            </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <footer style="text-align:center;padding:1.5rem 0;color:#94a3b8">Â© 2025 GoCampus Project</footer>

  <!-- Mark Paid Modal -->
  <div id="markPaidModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000">
    <div style="background:#0f172a;padding:1rem;border-radius:10px;max-width:420px;margin:auto;border:1px solid rgba(255,255,255,0.04)">
      <h3 style="margin-bottom:0.6rem">Mark Student as Paid</h3>
      <form id="markPaidForm" action="/mark_paid_admin" method="post">
        <input type="hidden" name="student_id" id="modal_student_id" />
        <div style="margin-bottom:0.5rem"><label>Amount (â‚¹)</label><input readonly name="amount_paid" value="15000" /></div>
        <div style="display:flex;gap:0.5rem"><button type="submit" class="btn btn-success" style="flex:1">Mark Paid</button><button type="button" class="btn" onclick="closeMarkPaidModal()" style="flex:1">Cancel</button></div>
      </form>
    </div>
  </div>

  <script>
    // Chart
    const chartData = {{ chart_data | tojson }} || {paid:0,unpaid:0};
    const ctx = document.getElementById('feeChart');
    if (ctx && chartData) {
      const g = ctx.getContext('2d');
      const grad1 = g.createLinearGradient(0,0,0,300); grad1.addColorStop(0,'#36A2EB');grad1.addColorStop(1,'#1E3A8A');
      const grad2 = g.createLinearGradient(0,0,0,300); grad2.addColorStop(0,'#94A3B8');grad2.addColorStop(1,'#475569');
      new Chart(ctx, { type:'pie', data:{labels:['Paid','Unpaid'],datasets:[{data:[chartData.paid,chartData.unpaid],backgroundColor:[grad1,grad2],borderColor:'#00000000'}] }, options:{responsive:true,maintainAspectRatio:false} });
      ctx.parentElement.style.height='280px'
    }

    // form validations
    document.getElementById('fee_paid').addEventListener('change', function(){ const g=document.getElementById('amount-group'); if(this.value==='1'){ if(g) g.style.display='block'; } else if(g) g.style.display='none';});

    // Mark paid modal helpers
    function showMarkPaidModal(id){ document.getElementById('modal_student_id').value = id; document.getElementById('markPaidModal').style.display='flex'; }
    function closeMarkPaidModal(){ document.getElementById('markPaidModal').style.display='none'; }

    // close modal when clicking outside
    document.getElementById('markPaidModal')?.addEventListener('click', function(e){ if(e.target===this) closeMarkPaidModal();});
  </script>
</body>
</html>
 